name: CI/CD Pipeline

on:
  pull_request:
    branches: [ main, master, develop ]
  push:
    branches: [ main, master, develop ]

jobs:
  python-cli-test:
    name: Python CLI Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv venv
          uv pip install -r requirements.txt
      
      - name: Test CLI Help Command
        run: |
          source .venv/bin/activate
          python cli.py --help
      
      - name: Test CLI Init Command
        run: |
          source .venv/bin/activate
          python cli.py init
      
      - name: Test CLI List Commands
        run: |
          source .venv/bin/activate
          python cli.py list-subjects || true
          python cli.py list-topics || true
      
      - name: Test Interactive Mode (Basic)
        run: |
          source .venv/bin/activate
          echo -e "help\nexit" | python cli.py
      
      - name: Verify Core Imports
        run: |
          source .venv/bin/activate
          python -c "from core import Topic, Syllabus, Question, Subject, KnowledgeBase"
          python -c "from core.gemini_processor import GeminiProcessor"
          python -c "from core.rag import RAGEngine"
      
      - name: Check CLI Syntax
        run: |
          source .venv/bin/activate
          python -m py_compile cli.py
          python -m py_compile core/*.py

  nodejs-version-check:
    name: Node.js Version Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify Node.js version
        run: |
          node --version
          npm --version
          echo "Node.js version meets minimum requirement (18+)"
      
      - name: Cache Node.js dependencies
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install Node.js dependencies
        working-directory: ./frontend
        run: |
          npm ci || npm install
      
      - name: Check for Node.js vulnerabilities
        working-directory: ./frontend
        run: |
          npm audit --audit-level=moderate
        continue-on-error: true

  security-check:
    name: Security Analysis
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      
      - name: Check for known vulnerabilities in dependencies
        run: |
          pip install -r requirements.txt
          safety check --json || echo "Safety check completed with warnings"
        continue-on-error: true
      
      - name: Run Bandit security scan
        run: |
          bandit -r . -f json -o bandit-report.json --exclude './frontend,./data,./docs,./.git' || true
          bandit -r . -ll --exclude './frontend,./data,./docs,./.git'
        continue-on-error: true
      
      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
      
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript
          queries: security-and-quality
      
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
      
      - name: Check for hardcoded secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  lint-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 pylint
      
      - name: Run flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude=./frontend,./data,./.git
        continue-on-error: true
      
      - name: Run pylint on core modules
        run: |
          pip install -r requirements.txt
          pylint core/*.py --disable=all --enable=E,F --exit-zero
        continue-on-error: true

  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [python-cli-test, nodejs-version-check]
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install uv
          uv venv
          uv pip install -r requirements.txt
      
      - name: Create test syllabus
        run: |
          mkdir -p test_data
          cat > test_data/test_syllabus.txt << 'EOF'
          Machine Learning Basics
          - Introduction to ML
          - Supervised Learning
          - Unsupervised Learning
          
          Deep Learning
          - Neural Networks
          - CNNs
          - RNNs
          EOF
      
      - name: Test subject creation workflow
        run: |
          source .venv/bin/activate
          python cli.py init
          python cli.py create-subject "Test Subject" --syllabus-file test_data/test_syllabus.txt || echo "Subject creation test completed"
      
      - name: Test topic and question commands
        run: |
          source .venv/bin/activate
          python cli.py add-topic "Test Topic" --summary "Test summary" --key-points "Point1,Point2,Point3"
          python cli.py list-topics
          python cli.py add-question "Test Topic" "What is test?" "This is a test" --difficulty easy
          python cli.py list-questions
      
      - name: Test learning aids generation
        run: |
          source .venv/bin/activate
          python cli.py show-difference --example tcp_vs_udp || true
          python cli.py generate-mindmap || true
      
      - name: Cleanup test data
        if: always()
        run: |
          rm -rf test_data

  dependency-check:
    name: Dependency Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Check Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          pip-audit --desc --require requirements.txt || echo "Dependency check completed"
        continue-on-error: true
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check Node.js dependencies
        working-directory: ./frontend
        run: |
          npm install
          npm outdated || echo "Some packages may be outdated"
        continue-on-error: true

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [python-cli-test, nodejs-version-check, security-check, lint-check, integration-test, dependency-check]
    if: always()
    permissions:
      contents: read
    
    steps:
      - name: Check job results
        run: |
          echo "## CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Python CLI Tests: ${{ needs.python-cli-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Node.js Version Check: ${{ needs.nodejs-version-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Security Check: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Lint Check: ${{ needs.lint-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Integration Tests: ${{ needs.integration-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "✅ Dependency Check: ${{ needs.dependency-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pipeline completed at $(date)" >> $GITHUB_STEP_SUMMARY
